{% extends "layout.html" %}
{% block title %}Quản lý Tài chính{% endblock %}

{% block content %}
<div class="finance-container animated fadeIn">

    <div class="header-action-container mb-4">
        <h2 class="dashboard-title"><i class="fas fa-wallet mr-2"></i>Quản lý tài chính CLB</h2>
        <div class="current-balance">
            <span class="label">Số dư hiện tại:</span>
            <span class="value">{{ "{:,.0f}".format(so_du) }} đ</span>
        </div>
    </div>

    <div class="stats-grid">
        <div class="stat-card green">
            <div class="stat-icon"><i class="fas fa-arrow-down"></i></div>
            <div class="stat-info">
                <h4>Tổng thu</h4>
                <p>{{ "{:,.0f}".format(tong_thu) }} đ</p>
            </div>
        </div>
        <div class="stat-card red">
            <div class="stat-icon"><i class="fas fa-arrow-up"></i></div>
            <div class="stat-info">
                <h4>Tổng chi</h4>
                <p>{{ "{:,.0f}".format(tong_chi) }} đ</p>
            </div>
        </div>
        <div class="stat-card orange">
            <div class="stat-icon"><i class="fas fa-history"></i></div>
            <div class="stat-info">
                <h4>Chờ xác nhận</h4>
                <p>{{ pending_count }} khoản</p>
            </div>
        </div>
    </div>

    <div class="finance-tabs-wrapper mt-4">
        <div class="finance-tabs">
            <button class="tab-btn active" onclick="showTab('thu')"><i class="fas fa-file-invoice-dollar mr-2"></i>Khoản thu</button>
            <button class="tab-btn" onclick="showTab('chi')"><i class="fas fa-shopping-cart mr-2"></i>Khoản chi</button>
        </div>
    </div>

    <div id="tab-thu" class="tab-content active">
        {% if co_quyen_quan_ly %}
        <div class="modern-card finance-form-card mb-4">
            <h4 class="mb-3">Thêm khoản thu mới</h4>
            <form method="POST" action="{{ url_for('finance.them_thu') }}" class="inline-form">
                <div class="input-group">
                    <i class="fas fa-money-bill-wave"></i>
                    <input type="number" name="so_tien" placeholder="Số tiền (đ)..." required>
                </div>
                <div class="input-group">
                    <i class="fas fa-sticky-note"></i>
                    <input type="text" name="ghi_chu" placeholder="Nội dung khoản thu...">
                </div>
                <button type="submit" class="btn-submit-thu">Thêm khoản thu</button>
            </form>
        </div>
        {% endif %}

        <div class="modern-card">
            <div class="table-responsive">
                <table class="custom-table">
                    <thead>
                        <tr>
                            <th>Ngày</th>
                            <th>Số tiền</th>
                            <th>Nội dung</th>
                            <th>Thành viên</th>
                            <th>Trạng thái</th>
                            <th class="text-right">Hành động</th>
                        </tr>
                    </thead>
                    <tbody>
                    {% for t in thu %}
                        <tr>
                            <td class="text-muted">{{ t.ngay }}</td>
                            <td class="text-success font-weight-bold">+ {{ "{:,.0f}".format(t.so_tien) }} đ</td>
                            <td>{{ t.ghi_chu }}</td>
                            <td><span class="user-tag">{{ t.member.ho_ten if t.member else "—" }}</span></td>
                            <td>
                                {% if t.da_xac_nhan %}
                                    <span class="badge-status active">Đã xác nhận</span>
                                {% else %}
                                    <span class="badge-status warning">Chờ xác nhận</span>
                                {% endif %}
                            </td>
                            <td class="text-right action-btns">
                                {% if not t.da_xac_nhan and t.member and current_user.member and t.member.id == current_user.member.id %}
                                <form method="POST" action="{{ url_for('finance.upload_anh_chuyen_khoan', finance_id=t.id) }}" enctype="multipart/form-data" class="d-inline">
                                    <label class="btn-icon upload-btn" title="Upload ảnh minh chứng">
                                        <i class="fas fa-camera"></i>
                                        <input type="file" name="anh_chuyen_khoan" hidden onchange="this.form.submit()">
                                    </label>
                                </form>
                                {% endif %}

                                {% if co_quyen_xac_nhan and not t.da_xac_nhan %}
                                <form method="POST" action="{{ url_for('finance.xac_nhan_thu', finance_id=t.id) }}" class="d-inline">
                                    <button type="submit" class="btn-icon confirm-btn" title="Xác nhận giao dịch">
                                        <i class="fas fa-check"></i>
                                    </button>
                                </form>
                                {% endif %}

                                {% if co_quyen_quan_ly %}
                                <form method="POST" action="{{ url_for('finance.xoa_giao_dich', finance_id=t.id) }}" class="d-inline" onsubmit="return confirm('Bạn có chắc chắn muốn xóa giao dịch này?')">
                                    <button type="submit" class="btn-icon delete-btn" title="Xóa giao dịch">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </form>
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="tab-chi" class="tab-content">
        {% if co_quyen_quan_ly %}
        <div class="modern-card finance-form-card mb-4">
            <h4 class="mb-3">Thêm khoản chi mới</h4>
            <form method="POST" action="{{ url_for('finance.them_chi') }}" class="inline-form">
                <div class="input-group">
                    <i class="fas fa-receipt"></i>
                    <input type="number" name="so_tien" placeholder="Số tiền chi..." required>
                </div>
                <div class="input-group">
                    <i class="fas fa-sticky-note"></i>
                    <input type="text" name="ghi_chu" placeholder="Lý do chi...">
                </div>
                <button type="submit" class="btn-submit-chi">Thêm khoản chi</button>
            </form>
        </div>
        {% endif %}

        <div class="modern-card">
            <div class="table-responsive">
                <table class="custom-table">
                    <thead>
                        <tr>
                            <th>Ngày</th>
                            <th>Số tiền</th>
                            <th>Nội dung</th>
                            <th class="text-right">Hành động</th>
                        </tr>
                    </thead>
                    <tbody>
                    {% for c in chi %}
                        <tr>
                            <td class="text-muted">{{ c.ngay }}</td>
                            <td class="text-danger font-weight-bold">- {{ "{:,.0f}".format(c.so_tien) }} đ</td>
                            <td>{{ c.ghi_chu }}</td>
                            <td class="text-right action-btns">
                                {% if co_quyen_quan_ly %}
                                <form method="POST" action="{{ url_for('finance.xoa_giao_dich', finance_id=c.id) }}" class="d-inline">
                                    <button class="btn-icon delete-btn"><i class="fas fa-trash-alt"></i></button>
                                </form>
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
<script>
function showTab(tabId) {
    // 1. Lấy tất cả các khối nội dung tab và ẩn chúng đi
    const allContents = document.querySelectorAll('.tab-content');
    allContents.forEach(content => {
        content.style.display = 'none';
        content.classList.remove('active');
    });

    // 2. Gỡ bỏ class active ở tất cả các nút bấm
    const allButtons = document.querySelectorAll('.tab-btn');
    allButtons.forEach(btn => {
        btn.classList.remove('active');
    });

    // 3. Hiển thị khối nội dung được chọn
    const targetContent = document.getElementById('tab-' + tabId);
    if (targetContent) {
        targetContent.style.display = 'block';
        targetContent.classList.add('active');
    }

    // 4. Đánh dấu nút bấm hiện tại là active
    if (event && event.currentTarget) {
        event.currentTarget.classList.add('active');
    }
}
</script>
{% endblock %}